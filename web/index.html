<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>MagicTube</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100vh;
                background-color: #dddddd;
            }

            .container {
                display: flex;
                flex-direction: row;
                width: 1440px;
                height: 900px;
                border: 1px solid #cccccc;
                padding: 0;
                background-color: #f4f4f9;
            }
            .player-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                flex-grow: 1;
            }
            #sidebar {
                width: 350px;
                padding-right: 2em;
                height: 100%;
                overflow-y: auto;
                overflow-x: hidden;
                scrollbar-gutter: stable;
            }
            #sidebar ul {
                padding: 0 0 0 1em;
            }
            #sidebar li {
                font-size: 12px;
                margin: 0 0 2em 0;
                list-style: none;
                display: flex;
                cursor: pointer;
                transition:
                    transform 0.2s ease,
                    box-shadow 0.2s ease;
            }
            #sidebar li h3 {
                margin: 0 0 0.5em 1em;
                font-weight: normal;
                line-height: 1.3;
            }
            #sidebar .thumbnail {
                position: relative;
                display: block;
                flex-shrink: 0;
                height: 60px;
                width: 108px;
                background-position: center;
                background-repeat: no-repeat;
                background-size: cover;
                border: 1px solid #fff;
                box-shadow: 5px 5px #5d27b0;
            }
            #sidebar li:hover {
                transform: scale(1.02);
                color: #5d27b0;
            }
            #sidebar .publish-time {
                display: block;
                font-size: 12px;
                color: gray;
                margin: 0 0 0em 1.3em;
            }
            #sidebar .duration-badge {
                position: absolute;
                bottom: 5px;
                right: 5px;
                background-color: rgba(0, 0, 0, 0.8);
                color: white;
                font-size: 10px;
                padding: 2px 4px;
                border-radius: 3px;
            }
            #player {
                width: 900px;
            }
            iframe {
                width: 100%;
                height: 600px;
                border: none;
            }
            .controls {
                margin-top: 30px;
                text-align: center;
            }
            input[type="text"] {
                padding: 10px;
                font-size: 16px;
                width: 400px;
            }
            button {
                padding: 10px 20px;
                font-size: 16px;
                margin-left: 10px;
                cursor: pointer;
            }
            #the_code {
                padding: 20px;
                color: gray;
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div id="sidebar"></div>
            <div class="player-container">
                <div id="player"></div>
                <div class="controls">
                    <input
                        type="text"
                        id="videoIdInput"
                        placeholder="Enter YouTube Video ID"
                    />

                    <button onclick="updateVideo()">Play</button>
                    <button onclick="copyCode()">Copy</button>
                </div>
            </div>
        </div>
        <script>
            const the_code =
                'oncl=e=>{let t=e.querySelectorAll("a, #video-title-link")[0].href.match(/[?&]v=([^&]+)/)[1];t&&navigator.clipboard.writeText(t).then(()=>console.log(t)).catch(e=>console.error("Failed",e))},document.querySelectorAll("ytd-compact-video-renderer").forEach(e=>{let t=e.querySelector("div.details");t&&t.addEventListener("click",e=>oncl(t))}),document.querySelectorAll("#contents ytd-rich-grid-media").forEach(e=>{let t=e.querySelector("#button");t&&t.addEventListener("click",t=>oncl(e))});';

            async function getLast10Videos(apiKey, videoId) {
                try {
                    const url = "https://www.googleapis.com/youtube/v3";
                    // Step 1: Get channelId from the videoId
                    const videoResponse = await fetch(
                        `${url}/videos?part=snippet&id=${videoId}&key=${aey}` +
                            "todo",
                    );
                    const videoData = await videoResponse.json();
                    const channelId = videoData.items[0].snippet.channelId;

                    // Step 2: Fetch the latest 10 videos from the channel
                    const searchResponse = await fetch(
                        `${url}/search?part=snippet&channelId=${channelId}&maxResults=10&order=date&type=video&key=${aey}` +
                            "todo",
                    );
                    const searchData = await searchResponse.json();
                    console.log("channel id", channelId);
                    // Step 3: Extract video titles and IDs
                    const videos = searchData.items.map((item) => ({
                        title: item.snippet.title,
                        id: item.id.videoId,
                        publishTime: item.snippet.publishTime.split("T")[0],
                    }));
                    // Fetch video durations for all video IDs
                    const videoIds = videos.map((video) => video.id).join(",");
                    const detailsResponse = await fetch(
                        `${url}/videos?part=contentDetails&id=${videoIds}&key=${aey}` +
                            "todo",
                    );
                    const detailsData = await detailsResponse.json();
                    const durations = detailsData.items.map((item) => ({
                        duration: item.contentDetails.duration,
                        id: item.id,
                    }));
                    const durationMap = new Map(
                        durations.map((d) => [d.id, d.duration]),
                    );
                    const sidebar = document.getElementById("sidebar");
                    const list = document.createElement("ul");

                    function formatDuration(duration) {
                        // Match the duration format using regex
                        const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
                        if (!match) return "0:00"; // Default to 0:00 if the duration format is invalid

                        // Extract hours, minutes, and seconds
                        const hours = match[1] ? parseInt(match[1]) : 0;
                        const minutes = match[2] ? parseInt(match[2]) : 0;
                        const seconds = match[3] ? parseInt(match[3]) : 0;

                        // Format into HH:MM:SS or MM:SS
                        if (hours > 0) {
                            return `${hours}:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
                        } else {
                            return `${minutes}:${String(seconds).padStart(2, "0")}`;
                        }
                    }

                    videos.forEach((video) => {
                        const listItem = document.createElement("li");
                        const thumbnailUrl = `https://i.ytimg.com/vi/${video.id}/hq720.jpg?sqp=-oaymwEnCNAFEJQDSFryq4qpAxkIARUAAIhCGAHYAQHiAQoIGBACGAY4AUAB&rs=AOn4CLBl279lOWUivihwM5q5KArHM5maeA`;
                        const duration = durationMap.get(video.id) || null;
                        const duration_clean = formatDuration(duration);
                        listItem.innerHTML = `
                            <div class="thumbnail" style="background-image: url('${thumbnailUrl}')">
                                <span class="duration-badge">${duration_clean}</span>
                            </div>
                            <div>
                                <h3 class="video-title">${video.title}</h3>
                                <span class="publish-time">${video.publishTime}</span>
                            </div>
                        `;
                        // <br/>${video.id}
                        listItem.addEventListener("click", () => {
                            loadVideoById(video.id);
                        });
                        list.appendChild(listItem);
                    });

                    sidebar.innerHTML = "";
                    sidebar.appendChild(list);
                } catch (error) {
                    alert("Error fetching videos");
                    console.error("Error fetching videos:", error);
                }
            }
            function loadVideoById(videoId) {
                if (player) {
                    player.loadVideoById(videoId);
                    player.playVideo();
                } else {
                    console.error("Player instance not initialized.");
                }
            }

            const aey = "AIzaSyBYX4lrK69RSW5ZWaturn4davwScZV";

            document
                .querySelector("input")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        updateVideo();
                    }
                });

            function copyCode(event) {
                navigator.clipboard
                    .writeText(the_code)
                    .then(() => console.log("Copied to clipboard"))
                    .catch((err) => console.error("Failed to copy:", err));
            }

            // Extract query parameter by name
            function getQueryParam(param) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(param);
            }

            // Fetch the video ID from the "v" query parameter
            const initialVideoId = getQueryParam("v");

            // Load the IFrame Player API code asynchronously
            const tag = document.createElement("script");
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName("script")[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

            let player;
            // Create the YouTube Player instance when API is ready
            function onYouTubeIframeAPIReady() {
                player = new YT.Player("player", {
                    height: "390",
                    width: "640",
                    videoId: initialVideoId || "",
                    playerVars: {
                        playsinline: 1,
                    },
                    events: {
                        onReady: onPlayerReady,
                        onStateChange: onPlayerStateChange,
                    },
                });
            }

            // Auto-play the initial video
            function onPlayerReady(event) {
                if (initialVideoId) {
                    event.target.playVideo();
                }
            }

            // Video state change handler (optional)
            function onPlayerStateChange(event) {
                console.log(event);
            }

            // Set default value for the input field
            document.addEventListener("DOMContentLoaded", () => {
                const inputField = document.getElementById("videoIdInput");
                if (initialVideoId) {
                    inputField.value = initialVideoId;
                    getLast10Videos(aey, initialVideoId);
                    if (player) {
                        player.playVideo(); // Play the video
                    } else {
                        console.error("YouTube player is not initialized.");
                    }
                }
            });
            // Update the video based on input
            function updateVideo() {
                const inputField = document.getElementById("videoIdInput");
                const newVideoId = inputField.value.trim();

                if (newVideoId) {
                    getLast10Videos(aey, newVideoId);
                    player.loadVideoById(newVideoId);
                    player.playVideo();
                } else {
                    alert("Please enter a valid YouTube video ID.");
                }
            }
        </script>
    </body>
</html>
